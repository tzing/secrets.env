name: Build

on:
  push:
    branches:
      - main
  pull_request:

env:
  # workaround for issue: g-dbus-error-quark: The name org.freedesktop.secrets was not provided by any .service files (2)
  PYTHON_KEYRING_BACKEND: keyring.backends.null.Keyring

jobs:
  test:
    name: Unit test
    runs-on: ubuntu-latest

    strategy:
      matrix:
        python-version:
          - "3.9"
          - "3.10"
          - "3.11"
          - "3.12"

    steps:
      - uses: actions/checkout@v3

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}

      - uses: actions/cache@v3
        with:
          path: |
            ~/.cache/pip
            ~/.cache/pypoetry
          key: ${{ runner.os }}-python-${{ matrix.python-version }}-poetry-${{ hashFiles('poetry.lock') }}

      - name: Install dependencies
        run: |
          pip install poetry
          poetry install --all-extras

      - name: Run pytest
        run: |
          poetry run pytest

  integration:
    name: Integretion test
    runs-on: ubuntu-latest

    env:
      VAULT_ADDR: http://localhost:8200
      VAULT_TOKEN: "sample-token"

    services:
      vault:
        image: public.ecr.aws/hashicorp/vault:latest
        env:
          VAULT_LOCAL_CONFIG: '{"disable_mlock": true, "backend": {"file": {"path": "/vault/file"}}}'
          VAULT_DEV_ROOT_TOKEN_ID: ${{ env.VAULT_TOKEN }}
        ports:
          - 8200:8200

    steps:
      - name: Get Vault CLI
        run: |
          curl -fsSL https://apt.releases.hashicorp.com/gpg | sudo apt-key add -
          sudo apt-add-repository "deb [arch=amd64] https://apt.releases.hashicorp.com $(lsb_release -cs) main"
          sudo apt-get update && sudo apt-get install vault

      - name: Setup secrets
        run: |
          vault secrets enable -path kv1 -version=1 kv
          vault secrets enable -path kv2 -version=2 kv

          vault kv put kv1/test - << EoS
            {
              "foo": "hello"
            }
          EoS

          vault kv put kv2/test - << EoS
            {
              "foo": "hello, world",
              "test": {
                "name.with-dot": "sample-value"
              }
            }
          EoS

      - uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - uses: actions/cache@v3
        with:
          path: |
            ~/.cache/pip
            ~/.cache/pypoetry
          key: ${{ runner.os }}-python-poetry-${{ hashFiles('poetry.lock') }}

      - uses: actions/checkout@v3

      - name: Install dependencies
        run: |
          pip install poetry
          poetry install

      - name: Run pytest
        run: |
          poetry run pytest -m integration_test

  lint:
    name: Run linter
    runs-on: ubuntu-latest
    steps:
      - uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - uses: actions/cache@v3
        with:
          path: |
            ~/.cache/pip
            ~/.cache/pypoetry
          key: ${{ runner.os }}-python-poetry-${{ hashFiles('poetry.lock') }}

      - uses: actions/checkout@v3

      - name: Install dependencies
        run: |
          pip3 install poetry
          poetry install --all-extras

      - name: Coding style check
        run: |
          poetry run ruff check .

      - name: Type check
        run: |
          poetry run pyright
