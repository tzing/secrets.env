name: Build

on:
  push:
    branches:
      - trunk
    tags:
      - v*
  pull_request:

env:
  # python version for the jobs that does not need to run on all versions
  MAIN_PYTHON_VERSION: "3.10"

jobs:
  test:
    name: Run tests
    runs-on: ubuntu-latest

    strategy:
      matrix:
        python-version:
          - "3.8"
          - "3.9"
          - "3.10"
          - "3.11-dev"

    services:
      vault:
        image: vault:latest
        env:
          VAULT_LOCAL_CONFIG: '{"disable_mlock": true, "backend": {"file": {"path": "/vault/file"}}}'
          VAULT_DEV_ROOT_TOKEN_ID: "!ntegr@t!0n-test"
        ports:
          - 8200:8200

    steps:
      - uses: actions/checkout@v3

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v3
        with:
          python-version: ${{ matrix.python-version }}

      - uses: actions/cache@v3
        with:
          path: |
            ~/.cache/pip
            ~/.cache/pypoetry/virtualenvs
          key: ${{ runner.os }}-python-${{ matrix.python-version }}-poetry-${{ hashFiles('poetry.lock') }}

      - name: Get vault
        run: |
          curl -fsSL https://apt.releases.hashicorp.com/gpg | sudo apt-key add -
          sudo apt-add-repository "deb [arch=amd64] https://apt.releases.hashicorp.com $(lsb_release -cs) main"
          sudo apt-get update && sudo apt-get install vault

      - name: Setup secrets
        env:
          VAULT_ADDR: http://localhost:8200
          VAULT_TOKEN: "!ntegr@t!0n-test"
        run: |
          vault secrets enable -path kv1 -version=1 kv
          vault secrets enable -path kv2 -version=2 kv

          vault kv put kv1/test - << EoS
            {
              "foo": "hello",
              "bar": {
                "baz": "world"
              }
            }
          EoS

          vault kv put kv2/test - << EoS
            {
              "foo": "hello, world",
              "bar": {
                "baz": "hello, vault"
              },
              "test.key": "value-1",
              "test": {
                "key": "value-2",
                "key.2": "value-3"
              },
              "": {
                "n/a": "value-4",
                "\"special key\"": "value-5"
              }
            }
          EoS

      - name: Install dependencies
        run: |
          python -m pip install poetry
          poetry install --no-root -E toml -E yaml

      - name: Run pytest
        run: |
          poetry run python -m pytest --cov-report xml

      - name: Code coverage summary report
        if: matrix.python-version == env.MAIN_PYTHON_VERSION
        uses: irongut/CodeCoverageSummary@v1.3.0
        with:
          filename: coverage.xml
          format: markdown
          output: both

      - name: Add coverage PR comment
        if: matrix.python-version == env.MAIN_PYTHON_VERSION && github.event_name == 'pull_request'
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          recreate: true
          path: code-coverage-results.md

  lint:
    name: Run linter
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - uses: actions/setup-python@v3
        with:
          python-version: ${{ env.MAIN_PYTHON_VERSION }}

      - uses: actions/cache@v3
        with:
          path: |
            ~/.cache/pip
            ~/.cache/pypoetry/virtualenvs
          key: ${{ runner.os }}-python-${{ env.MAIN_PYTHON_VERSION }}-poetry-${{ hashFiles('poetry.lock') }}

      - name: Install dependencies
        run: |
          python -m pip install poetry
          poetry install --no-root

      - name: Linting
        run: |
          poetry run flake8

  publish:
    name: Release package to PyPI

    runs-on: ubuntu-latest

    needs:
      - test
      - lint

    # if: startsWith(github.event.ref, 'refs/tags/v')

    steps:
      - uses: actions/checkout@v3

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v3
        with:
          python-version: ${{ matrix.python-version }}

      - uses: actions/cache@v3
        with:
          path: |
            ~/.cache/pip
            ~/.cache/pypoetry/virtualenvs
          key: ${{ runner.os }}-python-${{ matrix.python-version }}-poetry-${{ hashFiles('poetry.lock') }}

      - name: Install dependencies
        run: |
          python -m pip install poetry

      - name: Check version
        run: |
          export PACKAGE_VERSION="$(poetry version --short)"
          export TAG_VERSION="${GITHUB_REF_NAME:1}"

          echo "package version: $PACKAGE_VERSION"
          echo "github ref: $TAG_VERSION"

          [[ "x$PACKAGE_VERSION" == "x$TAG_VERSION" ]]

      - name: Build
        run: |
          poetry build

      - name: Workaround for package naming issue
        # https://github.com/python-poetry/poetry/issues/5782
        run: |
          for name in $(find dist -type f); do
            name_rec=$(echo $name | sed -E s/secrets.env/secrets.env/)
            [[ "x$name" != "x$name_rec" ]] && mv -v "$name" "$name_rec"
          done

      - name: Publish a Python distribution to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          password: ${{ secrets.PYPI_API_TOKEN }}
